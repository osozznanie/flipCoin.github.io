<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>3D Монетка | Игра на баланс</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", sans-serif;
        min-height: 100vh;
        background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        color: #fff;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      .container {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        padding: 2rem;
        border-radius: 20px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        text-align: center;
        width: 400px;
        max-width: 90%;
      }

      h1 {
        margin-bottom: 1rem;
        font-size: 2.2rem;
        background: linear-gradient(135deg, #e0e0e0, #ffffff);
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
      }

      .balance {
        background: rgba(255, 255, 255, 0.15);
        padding: 1rem;
        border-radius: 10px;
        margin: 1rem 0;
        font-size: 1.2rem;
        border: 1px solid rgba(255, 255, 255, 0.2);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }

      .coin-container {
        perspective: 1000px;
        margin: 2rem auto;
        width: 200px;
        height: 200px;
      }

      .coin {
        position: relative;
        width: 100%;
        height: 100%;
        transform-style: preserve-3d;
        transition: transform 3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        filter: drop-shadow(0 0 15px rgba(255, 215, 0, 0.3));
      }

      .coin-side {
        position: absolute;
        width: 100%;
        height: 100%;
        border-radius: 50%;
        backface-visibility: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2.5rem;
        font-weight: bold;
      }

      .black {
        background: linear-gradient(45deg, #1a1a1a, #333);
        box-shadow: inset 0 0 20px rgba(255, 255, 255, 0.2);
        transform: rotateY(0deg);
      }

      .buttons {
        display: flex;
        gap: 1.5rem;
        justify-content: center;
        margin-top: 2rem;
      }

      .bet-input {
        width: 100%;
        padding: 1rem;
        margin: 1.5rem 0;
        border: none;
        border-radius: 10px;
        background: rgba(255, 255, 255, 0.15);
        color: white;
        text-align: center;
        font-size: 1.1rem;
        box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.2);
        transition: all 0.3s;
        border: 1px solid rgba(255, 255, 255, 0.1);
      }

      .bet-input:focus {
        outline: none;
        background: rgba(255, 255, 255, 0.2);
        box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.2),
          0 0 8px rgba(255, 255, 255, 0.3);
      }

      button {
        padding: 1rem 2rem;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        font-size: 1rem;
        transition: all 0.3s;
        text-transform: uppercase;
        letter-spacing: 1px;
        font-weight: bold;
        position: relative;
        overflow: hidden;
        z-index: 1;
      }

      button::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(rgba(255, 255, 255, 0.2), transparent);
        transform: translateY(-100%);
        transition: transform 0.3s;
        z-index: -1;
      }

      button:hover::before {
        transform: translateY(0);
      }

      .black-btn {
        background: linear-gradient(to bottom, #333, #1a1a1a);
        color: white;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
      }

      .white-btn {
        background: linear-gradient(to bottom, #fff, #e0e0e0);
        color: #333;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
      }

      button:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
      }

      button:active {
        transform: translateY(0);
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
      }

      .result {
        margin-top: 1.5rem;
        font-size: 1.2rem;
        min-height: 1.5em;
        color: #fff;
        padding: 1rem;
        border-radius: 10px;
        transition: all 0.5s;
        opacity: 0.9;
      }

      .win {
        background: rgba(46, 213, 115, 0.3);
        box-shadow: 0 0 20px rgba(46, 213, 115, 0.4);
        border: 1px solid rgba(46, 213, 115, 0.5);
      }

      .lose {
        background: rgba(255, 71, 87, 0.3);
        box-shadow: 0 0 20px rgba(255, 71, 87, 0.4);
        border: 1px solid rgba(255, 71, 87, 0.5);
      }

      .user-info {
        font-size: 0.8rem;
        opacity: 0.7;
        margin-top: 0.5rem;
      }

      @keyframes spin {
        0% {
          transform: rotateY(0deg);
        }
        100% {
          transform: rotateY(360deg);
        }
      }

      .spin {
        animation: spin 3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
      }

      .container::before {
        content: "";
        position: absolute;
        top: -2px;
        left: -2px;
        right: -2px;
        bottom: -2px;
        background: linear-gradient(
          45deg,
          transparent,
          rgba(255, 255, 255, 0.1),
          transparent
        );
        z-index: -1;
        border-radius: 22px;
        animation: glowing 2s linear infinite;
      }

      @keyframes glowing {
        0% {
          background-position: 0 0;
        }
        50% {
          background-position: 400% 0;
        }
        100% {
          background-position: 0 0;
        }
      }

      .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        opacity: 0;
        transition: opacity 0.3s;
        pointer-events: none;
      }

      .loading-spinner {
        width: 50px;
        height: 50px;
        border: 5px solid rgba(255, 255, 255, 0.3);
        border-top: 5px solid #fff;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      .loading-active {
        opacity: 1;
        pointer-events: all;
      }
    </style>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
  </head>
  <body>
    <div class="loading-overlay" id="loadingOverlay">
      <div class="loading-spinner"></div>
    </div>
    <div class="container">
      <h1>3D Монетка</h1>
      <div class="balance" id="balance">Баланс: загрузка...</div>
      <div class="user-info" id="userInfo"></div>
      <input
        type="number"
        class="bet-input"
        id="betAmount"
        placeholder="Введите ставку"
        min="1"
        max="1000"
        value="100"
      />
      <div class="coin-container">
        <div class="coin" id="coin">
          <div class="coin-side black">B</div>
        </div>
      </div>
      <div class="buttons">
        <button class="black-btn" id="blackButton" onclick="makeGuess('black')">
          Чёрная
        </button>
        <button class="white-btn" id="whiteButton" onclick="makeGuess('white')">
          Белая
        </button>
      </div>
      <div class="result" id="result"></div>
    </div>

    <script>
      const tg = window.Telegram.WebApp;
      let isAnimating = false;
      let userBalance = 0;
      let currentChatId = null;
      const loadingOverlay = document.getElementById("loadingOverlay");

      function showLoading() {
        loadingOverlay.classList.add("loading-active");
      }

      function hideLoading() {
        loadingOverlay.classList.remove("loading-active");
      }

      async function fetchBalance(chatId) {
        showLoading();
        try {
          const response = await fetch(
            `http://localhost:8080/wallet?chatId=${chatId}`
          );
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          const data = await response.json();
          document.getElementById(
            "balance"
          ).textContent = `Баланс: ${data.balance} TK`;
          userBalance = data.balance;
          return data.balance;
        } catch (error) {
          console.error("Ошибка при получении баланса:", error);
          document.getElementById(
            "balance"
          ).textContent = `Ошибка загрузки баланса`;
          return 0;
        } finally {
          hideLoading();
        }
      }

      async function updateBalanceAndNotify(amount, won) {
        if (!currentChatId) return;

        const timeStamp = new Date().toISOString();
        const gameData = {
          userID: currentChatId,
          amount: amount,
          won: won,
          timeStamp: timeStamp,
        };

        console.log("Sending game data to Telegram:", gameData);

        userBalance = won ? userBalance + amount : userBalance - amount;
        updateBalanceDisplay();

        try {
          const webAppData = {
            name: `Coin ${amount}`,
            won: won,
          };

          tg.sendData(JSON.stringify(webAppData));
          await fetchBalance(currentChatId);
        } catch (error) {
          console.error("Ошибка при отправке данных:", error);
        }
      }

      async function makeGuess(guess) {
        if (isAnimating) return;

        const bet = parseInt(document.getElementById("betAmount").value);
        if (isNaN(bet) || bet <= 0 || bet > userBalance) {
          document.getElementById("result").textContent =
            "Неверная ставка или недостаточно средств";
          document.getElementById("result").className = "result lose";
          return;
        }

        document.getElementById("blackButton").disabled = true;
        document.getElementById("whiteButton").disabled = true;

        isAnimating = true;
        const coin = document.getElementById("coin");
        const result = document.getElementById("result");
        result.textContent = "Монетка вертится...";
        result.className = "result";

        coin.classList.remove("spin");
        void coin.offsetWidth; 

        const random = Math.random();
        const outcome = random < 0.5 ? "black" : "white";

        coin.classList.add("spin");

        const won = guess === outcome;

        setTimeout(async () => {
          if (won) {
            result.textContent = `Вы выиграли ${bet} TK!`;
            result.className = "result win";
          } else {
            result.textContent = `Вы проиграли ${bet} TK.`;
            result.className = "result lose";
          }

          await updateBalanceAndNotify(bet, won);

          setTimeout(() => {
            isAnimating = false;
            document.getElementById("blackButton").disabled = false;
            document.getElementById("whiteButton").disabled = false;
          }, 500);
        }, 3000);
      }

      document.addEventListener("DOMContentLoaded", async function () {
        showLoading();
        tg.ready();
        tg.expand();

        window.addEventListener("beforeunload", function (e) {
          if (isAnimating) {
            e.preventDefault();
            e.returnValue = "";
          }
        });

        const urlParams = new URLSearchParams(window.location.search);
        currentChatId = urlParams.get("user_id");

        const userInfo = document.getElementById("userInfo");
        userInfo.textContent = `ID: ${currentChatId}`;

        console.log("URL Parameters:", {
          chatId: currentChatId,
          fullUrl: window.location.href,
        });

        if (currentChatId) {
          try {
            userBalance = await fetchBalance(currentChatId);
          } catch (err) {
            console.error("Failed to fetch balance:", err);
          }
        }

        hideLoading();
      });

      function updateBalanceDisplay() {
        document.getElementById(
          "balance"
        ).textContent = `Баланс: ${userBalance} TK`;
      }
    </script>
  </body>
</html>
